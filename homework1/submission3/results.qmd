---
jupyter:
  kernelspec:
    display_name: R
    language: R
    name: ir
---


```{r}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, ggplot2, dplyr, lubridate, stringr, readxl, data.table, gdata, scales, kableExtra)
```

# Load Data
```{r}
setwd('/Users/tammydang/Downloads/EMORY/ECON-470')

#function to read enrollment data----------------------------------------
 read_enroll <- function(path) {
    read_csv(
      path,
      skip = 1,
      col_names = c("contractid","planid","ssa","fips","state","county","enrollment"),
      col_types = cols(
        contractid = col_character(),
        planid     = col_double(),
        ssa        = col_double(),
        fips       = col_double(),
        state      = col_character(),
        county     = col_character(),
        enrollment = col_double()
      ),
      na = "*",
      show_col_types = FALSE,
      progress = FALSE
    )
  }

#function to read contract data
  read_contract <- function(path) {
    read_csv(
      path,
      skip = 1,
      col_names = c(
        "contractid","planid","org_type","plan_type","partd","snp","eghp",
        "org_name","org_marketing_name","plan_name","parent_org","contract_date"
      ),
      col_types = cols(
        contractid = col_character(),
        planid     = col_double(),
        org_type   = col_character(),
        plan_type  = col_character(),
        partd      = col_character(),
        snp        = col_character(),
        eghp       = col_character(),
        org_name   = col_character(),
        org_marketing_name = col_character(),
        plan_name  = col_character(),
        parent_org = col_character(),
        contract_date = col_character()
      ),
      show_col_types = FALSE,
      progress = FALSE
    )
  }

#load one month --------------------------------------------------
 load_month <- function(m, y) {
    c_path <- paste0("data/ma-data/ma-data/ma/enrollment/Extracted Data/CPSC_Contract_Info_", y, "_", m, ".csv")
    e_path <- paste0("data/ma-data/ma-data/ma/enrollment/Extracted Data/CPSC_Enrollment_Info_", y, "_", m, ".csv")

    contract.info <- read_contract(c_path) %>%
      distinct(contractid, planid, .keep_all = TRUE)   

    enroll.info <- read_enroll(e_path)

    contract.info %>%
      left_join(enroll.info, by = c("contractid","planid")) %>%
      mutate(month = as.integer(m), year = y)
  }

 # Read all months, then tidy into a year-----------------------------
 
 #load_year is for plan.year for the monthlist
 y = 2018
monthlist <- if (y == 2006) sprintf("%02d", 7:12) else sprintf("%02d", 1:12)

# ALL MONTHS STACKED ON TOP OF EACH OTHER
plan.year <- map_dfr(monthlist, ~ load_month(.x, y)) %>%
    arrange(contractid, planid, state, county, month) %>%
    group_by(state, county) %>%
    fill(fips, .direction = "downup") %>%                
    ungroup() %>%
    group_by(contractid, planid) %>%
    fill(plan_type, partd, snp, eghp, plan_name, .direction = "downup") %>%
    ungroup() %>%
    group_by(contractid) %>%
    fill(org_type, org_name, org_marketing_name, parent_org, .direction = "downup") %>%
    ungroup()

 # Collapse to yearly panel ------------------------------------------------
#final.plans <- plan.year %>%
#  group_by(contractid, planid, fips, year) %>%
#  arrange(month, .by_group = TRUE) %>%
#  summarize(
#    n_nonmiss        = sum(!is.na(enrollment)),
#    avg_enrollment   = ifelse(n_nonmiss > 0, mean(enrollment, na.rm = TRUE), NA_real_),
#    sd_enrollment    = ifelse(n_nonmiss > 1, sd(enrollment, na.rm = TRUE), NA_real_),
#    min_enrollment   = ifelse(n_nonmiss > 0, min(enrollment, na.rm = TRUE), NA_real_),
#    max_enrollment   = ifelse(n_nonmiss > 0, max(enrollment, na.rm = TRUE), NA_real_),
#    first_enrollment = ifelse(n_nonmiss > 0, first(na.omit(enrollment)), NA_real_),
#    last_enrollment  = ifelse(n_nonmiss > 0, last(na.omit(enrollment)), NA_real_),
#    state            = last(state),
#    county           = last(county),
#    org_type         = last(org_type),
#    plan_type        = last(plan_type),
#    partd            = last(partd),
#    snp              = last(snp),
#    .groups = "drop"
 # )

# read service data
  read_service_area <- function(path) {
    read_csv(
      path, skip = 1,
      col_names = c(
        "contractid","org_name","org_type","plan_type","partial","eghp",
        "ssa","fips","county","state","notes"
      ),
      col_types = cols(
        contractid = col_character(),
        org_name   = col_character(),
        org_type   = col_character(),
        plan_type  = col_character(),
        partial    = col_logical(),
        eghp       = col_character(),
        ssa        = col_double(),
        fips       = col_double(),
        county     = col_character(),
        state      = col_character(),
        notes      = col_character()
      ),
      na = "*",
      show_col_types = FALSE,
      progress = FALSE
    )
  }

 final.service.area <- service.year %>%
    group_by(contractid, fips, year) %>%
    arrange(month, .by_group = TRUE) %>%
    summarize(
      state     = last(state),
      county    = last(county),
      org_name  = last(org_name),
      org_type  = last(org_type),
      plan_type = last(plan_type),
      partial   = last(partial),
      eghp      = last(eghp),
      ssa       = last(ssa),
      notes     = last(notes),
      .groups = "drop"
    )
```

# Question 1: 
Provide a table of the count of plans under each plan type. Your table should look something like Table 1. (2 points)
```{r}
options(knitr.kable.NA = 0)
knitr::kable(plan.type.year1, 
             col.names=c("Plan Type","Count"),
             format.args=list(big.mark=","), booktabs = TRU)
```

# Question 2:
Remove all special needs plans (SNP), employer group plans (eghp), and all “800-series” plans. Provide an updated version of Table 1 after making these exclusions. (2 points)
```{r}
#remove all special needs plans
plan.type.year2 <- plan.data %>% 
  filter(snp == "No" & eghp == "No" & (planid < 800 | planid >= 900)) %>% 
  group_by(plan_type) %>% count() %>% arrange(-n)

#updated table
options(knitr.kable.NA = 0)
knitr::kable(plan.type.year2, 
             col.names=c("Plan Type","Count"),
             format.args=list(big.mark=","), booktabs = TRUE)
```

# Question 3:
Now repeat the same filters from part 2 but also focus only on counties in which plans are approved as per the service area files. With these data, provide a table of the average enrollments for each plan type. (2 points)
```{r}
#combine the service area with enrolled files
plan.type.enroll <- plan.data %>%
  inner_join(service.data %>% 
               select(contractid, fips, year), 
             by=c("contractid", "fips", "year")) %>%
  filter(snp == "No" & eghp == "No" & (planid < 800 | planid >= 900)) %>% 
  group_by(plan_type) %>% summarize(n=n(), enollment=mean(avg_enrollment, na.rm=TRUE)) %>% arrange(-n)


# provide table
options(knitr.kable.NA = 0)
knitr::kable(plan.type.enroll, digits=0,
             col.names=c("Plan Type","Count","Avg Enrollments"),
             format.args=list(big.mark=","), booktabs = TRUE)
```