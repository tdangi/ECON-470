---
title: "Homework 1 Submission 1"
format: pdf
author: Tammy Dang
---
GitHub Setup: https://github.com/tdangi/ECON-470

can use hint: BuildFinalData.R -- runs ALL individual codefiles to create giant medicare advantage dataset 

FOR THIS ENROLLMENT: (only need to worry about plan enrollment data and service area data -- under enrollment and service-area in ma-data)

```{r}
#get working directory
getwd()
setwd('/Users/tammydang/Downloads/EMORY/ECON-470')
```
```{r}
#import libraries
library(tidyverse)

#directory for locating data and data saving
data.hcris <- file.path('data/hcris-data') 
data.ma <-  file.path('data/ma-data')
data.save <- file.path('data/hmwk_data')
```

# Building the Data
GOAL: organize Monthly Plan Enrollment Data (1_plan-data.R) and Service Area files, focusing on 2018!

## Read Monthly Plan Enrollment Data

### functions
```{r}
#function to read enrollment data----------------------------------------
 read_enroll <- function(path) {
    read_csv(
      path,
      skip = 1,
      col_names = c("contractid","planid","ssa","fips","state","county","enrollment"),
      col_types = cols(
        contractid = col_character(),
        planid     = col_double(),
        ssa        = col_double(),
        fips       = col_double(),
        state      = col_character(),
        county     = col_character(),
        enrollment = col_double()
      ),
      na = "*",
      show_col_types = FALSE,
      progress = FALSE
    )
  }

#function to read contract data
  read_contract <- function(path) {
    read_csv(
      path,
      skip = 1,
      col_names = c(
        "contractid","planid","org_type","plan_type","partd","snp","eghp",
        "org_name","org_marketing_name","plan_name","parent_org","contract_date"
      ),
      col_types = cols(
        contractid = col_character(),
        planid     = col_double(),
        org_type   = col_character(),
        plan_type  = col_character(),
        partd      = col_character(),
        snp        = col_character(),
        eghp       = col_character(),
        org_name   = col_character(),
        org_marketing_name = col_character(),
        plan_name  = col_character(),
        parent_org = col_character(),
        contract_date = col_character()
      ),
      show_col_types = FALSE,
      progress = FALSE
    )
  }

#load one month --------------------------------------------------
 load_month <- function(m, y) {
    c_path <- paste0("data/ma-data/ma-data/ma/enrollment/Extracted Data/CPSC_Contract_Info_", y, "_", m, ".csv")
    e_path <- paste0("data/ma-data/ma-data/ma/enrollment/Extracted Data/CPSC_Enrollment_Info_", y, "_", m, ".csv")

    contract.info <- read_contract(c_path) %>%
      distinct(contractid, planid, .keep_all = TRUE)   

    enroll.info <- read_enroll(e_path)

    contract.info %>%
      left_join(enroll.info, by = c("contractid","planid")) %>%
      mutate(month = as.integer(m), year = y)
  }

 # Read all months, then tidy into a year-----------------------------
 
 #load_year is for plan.year for the monthlist
 y = 2018
monthlist <- if (y == 2006) sprintf("%02d", 7:12) else sprintf("%02d", 1:12)

# ALL MONTHS STACKED ON TOP OF EACH OTHER
plan.year <- map_dfr(monthlist, ~ load_month(.x, y)) %>%
    arrange(contractid, planid, state, county, month) %>%
    group_by(state, county) %>%
    fill(fips, .direction = "downup") %>%                
    ungroup() %>%
    group_by(contractid, planid) %>%
    fill(plan_type, partd, snp, eghp, plan_name, .direction = "downup") %>%
    ungroup() %>%
    group_by(contractid) %>%
    fill(org_type, org_name, org_marketing_name, parent_org, .direction = "downup") %>%
    ungroup()
 
 # Collapse to yearly panel ------------------------------------------------
  final.plans <- plan.year %>%
    group_by(contractid, planid, fips, year) %>%
    arrange(month, .by_group = TRUE) %>%
    summarize(
      n_nonmiss        = sum(!is.na(enrollment)),
      avg_enrollment   = ifelse(n_nonmiss > 0, mean(enrollment, na.rm = TRUE), NA_real_),
      sd_enrollment    = ifelse(n_nonmiss > 1, sd(enrollment, na.rm = TRUE), NA_real_),
      min_enrollment   = ifelse(n_nonmiss > 0, min(enrollment, na.rm = TRUE), NA_real_),
      max_enrollment   = ifelse(n_nonmiss > 0, max(enrollment, na.rm = TRUE), NA_real_),
      first_enrollment = ifelse(n_nonmiss > 0, first(na.omit(enrollment)), NA_real_),
      last_enrollment  = ifelse(n_nonmiss > 0,  last(na.omit(enrollment)), NA_real_),
      state            = last(state),
      county           = last(county),
      org_type         = last(org_type),
      plan_type        = last(plan_type),
      partd            = last(partd),
      snp              = last(snp),
      eghp             = last(eghp),
      org_name         = last(org_name),
      org_marketing_name = last(org_marketing_name),
      plan_name        = last(plan_name),
      parent_org       = last(parent_org),
      contract_date    = last(contract_date),
      year             = last(year),
      .groups = "drop"
    )

```

- read_enroll = read raw enrollment data, defining each column/variable to create a dataset
- load_month = load one month of the enrollment data

```{r}
#check read_enroll if it works
read_enroll('data/ma-data/ma-data/ma/enrollment/CPSC_Enrollment_2018_01.zip')
```


```{r}
#use plan.year to load the tibble
str(plan.year)
table(plan.year$month)
```

## Read Service Area Files
```{r}
# Read service area data -----------------------------------------
  read_service_area <- function(path) {
    read_csv(
      path, skip = 1,
      col_names = c(
        "contractid","org_name","org_type","plan_type","partial","eghp",
        "ssa","fips","county","state","notes"
      ),
      col_types = cols(
        contractid = col_character(),
        org_name   = col_character(),
        org_type   = col_character(),
        plan_type  = col_character(),
        partial    = col_logical(),
        eghp       = col_character(),
        ssa        = col_double(),
        fips       = col_double(),
        county     = col_character(),
        state      = col_character(),
        notes      = col_character()
      ),
      na = "*",
      show_col_types = FALSE,
      progress = FALSE
    )
  }

 # One-month loader --------------------------------------------------------
  load_month_sa <- function(m, y) {
    path <- paste0("data/ma-data/ma-data/ma/service-area/Extracted Data/MA_Cnty_SA_",y, "_", m, ".csv")
    
    read_service_area(path) %>%
      mutate(month = as.integer(m), year = y)
  }

  # Read all months, then tidy once ----------------------------------------
  service.year <- map_dfr(monthlist, ~ load_month_sa(.x, y))

  # Ensure stable order before fills
  service.year <- service.year %>%
    arrange(contractid, fips, state, county, month)

  # Fill missing identifiers/labels
  service.year <- service.year %>%
    group_by(state, county) %>%
    fill(fips, .direction = "downup") %>%
    ungroup() %>%
    group_by(contractid) %>%
    fill(plan_type, partial, eghp, org_type, org_name, .direction = "downup") %>%
    ungroup()

 final.service.area <- service.year %>%
    group_by(contractid, fips, year) %>%
    arrange(month, .by_group = TRUE) %>%
    summarize(
      state     = last(state),
      county    = last(county),
      org_name  = last(org_name),
      org_type  = last(org_type),
      plan_type = last(plan_type),
      partial   = last(partial),
      eghp      = last(eghp),
      ssa       = last(ssa),
      notes     = last(notes),
      .groups = "drop"
    )

```

### Check Service Year 2018
```{r}
service.year
str(service.year)
```

# Merge Service Data with Monthly Plan Enrollment Data
Merge the service area data into the monthly enrollment data using an “inner merge” (i.e., take only those rows that match between the datasets).
```{r}
service_merge <- final.service.area %>% inner_join(
  final.plans,
  by = c("contractid")
)

service_merge
```